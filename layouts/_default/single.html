{{ define "main" }}

<style>
    /* 1. THE RESET (Crucial Fix) */
    /* This overrides the padding/margins from baseof.html so the app fits perfectly */
    :root {
        --sidebar-width: 350px;
    }

    body {
        margin: 0 !important; /* Force margins to zero */
        padding: 0 !important;
        overflow: hidden; /* Kill scrollbars globally */
        height: 100vh;
        width: 100vw;
    }

    /* 2. The Main Container */
    .project-container {
        display: grid;
        grid-template-columns: var(--sidebar-width) 1fr;
        
        /* THE FIX: 
           100vh (Screen) - 90px (Header) - 70px (Footer) = ~160px 
           We use 160px to be safe.
        */
        height: calc(100vh - 160px); 
        
        width: 100%; 
        background: white;
    }

    /* 3. The Sidebar */
    .sidebar {
        padding: 2rem;
        border-right: 1px solid #eee;
        display: flex;
        flex-direction: column;
        justify-content: center;
        background: #fff;
        overflow-y: auto;
        box-sizing: border-box; /* Keeps padding inside the width */
    }

    /* 4. The Stage */
    .stage {
        background: #f0f0f0; /* Slightly darker grey to see the bounds */
        position: relative;
        width: 100%;
        height: 100%;
        overflow: hidden; /* Ensure nothing spills out */
        
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 40px; /* A buffer so the image doesn't touch the screen edge */
        box-sizing: border-box;
    }

    /* 5. The Image Logic */
    .slide {
        display: none;
        
        /* This is the "Smol Window" logic */
        /* It tells the image: "Be as big as possible, but NEVER exceed the container" */
        max-width: 100%;
        max-height: 100%;
        width: auto;
        height: auto;
        
        object-fit: contain;
        box-shadow: 0 20px 50px rgba(0,0,0,0.2);
    }

    .slide.active {
        display: block;
    }

    /* ... Buttons and Mobile styles remain the same ... */
    .nav-buttons { margin-top: 2rem; display: flex; gap: 1rem; }
    button { cursor: pointer; background: black; color: white; border: none; padding: 10px 20px; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 1px; }
    button:hover { opacity: 0.8; }
    .caption-display { margin-top: 1rem; font-size: 0.85rem; color: #666; font-style: italic; min-height: 1.2em; }

    @media (max-width: 768px) {
        .project-container { grid-template-columns: 1fr; grid-template-rows: auto 1fr; }
        .sidebar { height: auto; padding: 1rem; border-bottom: 1px solid #eee; border-right: none; }
        /* On mobile, we let the image take up 50% of the screen height */
        .stage { height: 50vh; padding: 10px; } 
    }
</style>

<div class="project-container">
    
    <aside class="sidebar">
        <h1 style="margin: 0 0 0.5rem 0; font-size: 1.5rem;">{{ .Title }}</h1>
        <p style="margin: 0 0 2rem 0; font-size: 0.9rem; color: #888;">{{ .Params.description }}</p>
        
        <div style="font-size: 0.9rem; line-height: 1.6; margin-bottom: 2rem;">
            {{ .Content }}
        </div>

        <div id="caption-target" class="caption-display">
            </div>

        <div class="nav-buttons">
            <button onclick="changeSlide(-1)">Prev</button>
            <button onclick="changeSlide(1)">Next</button>
        </div>
        
        <p style="margin-top: 2rem;"><a href="/projects" style="color:#ccc; text-decoration: none;">&larr; Back to Projects</a></p>
    </aside>

    <main class="stage">
        {{ range $index, $element := .Params.gallery }}
            
            {{ $imageRes := $.Resources.GetMatch .image }}
            {{ if $imageRes }}
                
                {{ $final := $imageRes.Resize "1600x" }} 
                
                <img src="{{ $final.RelPermalink }}" 
                     class="slide {{ if eq $index 0 }}active{{ end }}" 
                     data-title="{{ .title }}"
                     alt="{{ .title }}">
            {{ end }}

        {{ end }}
    </main>

</div>

<script>
    let currentIndex = 0;
    // Get all images with class "slide"
    const slides = document.querySelectorAll('.slide');
    const captionTarget = document.getElementById('caption-target');

    // Initialize first caption
    if(slides.length > 0) {
        captionTarget.innerText = slides[0].getAttribute('data-title');
    }

    function changeSlide(direction) {
        // 1. Remove 'active' from current
        slides[currentIndex].classList.remove('active');

        // 2. Calculate new index
        currentIndex += direction;

        // Loop logic: If at end, go to start. If at start, go to end.
        if (currentIndex >= slides.length) currentIndex = 0;
        if (currentIndex < 0) currentIndex = slides.length - 1;

        // 3. Add 'active' to new
        slides[currentIndex].classList.add('active');
        
        // 4. Update Caption text in sidebar
        captionTarget.innerText = slides[currentIndex].getAttribute('data-title');
    }
    
    // Optional: Keyboard navigation
    document.addEventListener('keydown', function(e) {
        if(e.key === "ArrowRight") changeSlide(1);
        if(e.key === "ArrowLeft") changeSlide(-1);
    });
</script>

{{ end }}